<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¹ã‚¯9çµ±åˆãƒ†ã‚¹ãƒˆ - åº—èˆ—é–“ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½</title>
    <link rel="stylesheet" href="kaikei/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ã‚¿ã‚¹ã‚¯9çµ±åˆãƒ†ã‚¹ãƒˆ - åº—èˆ—é–“ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½</h1>
        </header>

        <main>
            <div id="content-area">
                <div class="section-header">
                    <h2>è¦ä»¶7.1-7.5ã®çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
                    <div class="section-controls">
                        <button class="btn btn-primary" onclick="runIntegrationTest()">çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                        <button class="btn btn-secondary" onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>

                <div id="test-results">
                    <h3>ãƒ†ã‚¹ãƒˆå¯¾è±¡è¦ä»¶</h3>
                    <ul>
                        <li><strong>è¦ä»¶7.1:</strong> ãƒ‡ãƒ¼ã‚¿ã®åº—èˆ—ç§»å‹•é¸æŠç”»é¢è¡¨ç¤º</li>
                        <li><strong>è¦ä»¶7.2:</strong> è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ç§»å‹•</li>
                        <li><strong>è¦ä»¶7.3:</strong> ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨å±¥æ­´è¨˜éŒ²</li>
                        <li><strong>è¦ä»¶7.4:</strong> ç§»å‹•å±¥æ­´ã®è¡¨ç¤º</li>
                        <li><strong>è¦ä»¶7.5:</strong> é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°</li>
                    </ul>

                    <div id="test-status"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="kaikei/js/store-manager.js"></script>
    <script src="kaikei/js/data-manager.js"></script>
    <script src="kaikei/js/ui-manager.js"></script>
    <script>
        let storeManager;
        let dataManager;
        let uiManager;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                storeManager = new StoreManager();
                dataManager = new DataManager();
                uiManager = new UIManager(dataManager);
                
                await storeManager.loadStoreData();
                await dataManager.loadData();
                
                window.storeManager = storeManager;
                window.dataManager = dataManager;
                window.uiManager = uiManager;
                
                showStatus('åˆæœŸåŒ–å®Œäº†', 'success');
            } catch (error) {
                showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runIntegrationTest() {
            try {
                showStatus('çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'info');
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
                await setupTestData();
                
                const results = [];
                
                // è¦ä»¶7.1: ãƒ‡ãƒ¼ã‚¿ç§»å‹•é¸æŠç”»é¢è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
                results.push(await testRequirement71());
                
                // è¦ä»¶7.2: è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç§»å‹•ãƒ†ã‚¹ãƒˆ
                results.push(await testRequirement72());
                
                // è¦ä»¶7.3: ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨å±¥æ­´è¨˜éŒ²ãƒ†ã‚¹ãƒˆ
                results.push(await testRequirement73());
                
                // è¦ä»¶7.4: ç§»å‹•å±¥æ­´è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
                results.push(await testRequirement74());
                
                // è¦ä»¶7.5: é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ†ã‚¹ãƒˆ
                results.push(await testRequirement75());
                
                displayTestResults(results);
                
            } catch (error) {
                showStatus('çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
        async function setupTestData() {
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            await clearTestData();
            
            // ãƒ†ã‚¹ãƒˆåº—èˆ—ä½œæˆ
            const store1 = storeManager.addStore({
                name: 'æœ¬åº—',
                address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1',
                openDate: '2024-01-01',
                note: 'ãƒ†ã‚¹ãƒˆç”¨æœ¬åº—'
            });

            const store2 = storeManager.addStore({
                name: 'æ”¯åº—A',
                address: 'æ±äº¬éƒ½æ–°å®¿åŒº2-2-2',
                openDate: '2024-02-01',
                note: 'ãƒ†ã‚¹ãƒˆç”¨æ”¯åº—A'
            });

            // æœ¬åº—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«è¨­å®š
            storeManager.setActiveStore(store1.id);

            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
            for (let i = 1; i <= 3; i++) {
                dataManager.addRecord('sales', {
                    year: 2024,
                    month: 12,
                    amount: 100000 * i,
                    note: `ãƒ†ã‚¹ãƒˆå£²ä¸Šãƒ‡ãƒ¼ã‚¿${i}`
                });
            }
        }

        // è¦ä»¶7.1ãƒ†ã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿ç§»å‹•é¸æŠç”»é¢è¡¨ç¤º
        async function testRequirement71() {
            try {
                // UIManagerã®ãƒ‡ãƒ¼ã‚¿ç§»å‹•ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                const hasMethod = typeof uiManager.showDataMoveDialogInternal === 'function';
                
                // åº—èˆ—é¸æŠæ©Ÿèƒ½ã®ç¢ºèª
                const stores = storeManager.getStores();
                const hasMultipleStores = stores.length >= 2;
                
                return {
                    requirement: '7.1',
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•é¸æŠç”»é¢è¡¨ç¤º',
                    passed: hasMethod && hasMultipleStores,
                    details: `ç§»å‹•ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ¡ã‚½ãƒƒãƒ‰: ${hasMethod ? 'å®Ÿè£…æ¸ˆã¿' : 'æœªå®Ÿè£…'} | åº—èˆ—æ•°: ${stores.length}`
                };
                
            } catch (error) {
                return {
                    requirement: '7.1',
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•é¸æŠç”»é¢è¡¨ç¤º',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // è¦ä»¶7.2ãƒ†ã‚¹ãƒˆ: è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç§»å‹•
        async function testRequirement72() {
            try {
                // è¤‡æ•°é¸æŠæ©Ÿèƒ½ã®ç¢ºèª
                const hasSelectAllMethod = typeof uiManager.selectAllRecords === 'function';
                const hasClearSelectionMethod = typeof uiManager.clearSelection === 'function';
                const hasUpdateSelectionMethod = typeof uiManager.updateSelectionCount === 'function';
                
                // ä¸€æ‹¬ç§»å‹•ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª
                const hasBatchMoveMethod = typeof uiManager.showDataMoveDialog === 'function';
                
                const allMethodsExist = hasSelectAllMethod && hasClearSelectionMethod && 
                                       hasUpdateSelectionMethod && hasBatchMoveMethod;
                
                return {
                    requirement: '7.2',
                    name: 'è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç§»å‹•',
                    passed: allMethodsExist,
                    details: `é¸æŠæ©Ÿèƒ½: ${hasSelectAllMethod ? 'âœ“' : 'âœ—'} | é¸æŠè§£é™¤: ${hasClearSelectionMethod ? 'âœ“' : 'âœ—'} | é¸æŠæ•°æ›´æ–°: ${hasUpdateSelectionMethod ? 'âœ“' : 'âœ—'} | ä¸€æ‹¬ç§»å‹•: ${hasBatchMoveMethod ? 'âœ“' : 'âœ—'}`
                };
                
            } catch (error) {
                return {
                    requirement: '7.2',
                    name: 'è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç§»å‹•',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // è¦ä»¶7.3ãƒ†ã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨å±¥æ­´è¨˜éŒ²
        async function testRequirement73() {
            try {
                const stores = storeManager.getStores();
                const salesData = dataManager.getDataByCategory('sales');
                
                if (salesData.length === 0) {
                    throw new Error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œ
                const recordToMove = salesData[0];
                const originalStoreId = recordToMove.storeId;
                const targetStoreId = stores.find(s => s.id !== originalStoreId)?.id;
                
                if (!targetStoreId) {
                    throw new Error('ç§»å‹•å…ˆåº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ç§»å‹•å®Ÿè¡Œ
                const movedRecord = dataManager.moveRecordToStore('sales', recordToMove.id, targetStoreId);
                
                // å±¥æ­´è¨˜éŒ²ã®ç¢ºèª
                const history = dataManager.getDataMoveHistory(1);
                const hasHistoryRecord = history.length > 0;
                
                return {
                    requirement: '7.3',
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨å±¥æ­´è¨˜éŒ²',
                    passed: movedRecord.storeId === targetStoreId && hasHistoryRecord,
                    details: `ç§»å‹•æˆåŠŸ: ${movedRecord.storeId === targetStoreId ? 'âœ“' : 'âœ—'} | å±¥æ­´è¨˜éŒ²: ${hasHistoryRecord ? 'âœ“' : 'âœ—'}`
                };
                
            } catch (error) {
                return {
                    requirement: '7.3',
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨å±¥æ­´è¨˜éŒ²',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // è¦ä»¶7.4ãƒ†ã‚¹ãƒˆ: ç§»å‹•å±¥æ­´è¡¨ç¤º
        async function testRequirement74() {
            try {
                // å±¥æ­´è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª
                const hasHistoryDisplayMethod = typeof uiManager.showDataMoveHistory === 'function';
                
                // å±¥æ­´å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª
                const hasHistoryGetMethod = typeof dataManager.getDataMoveHistory === 'function';
                
                // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
                const history = dataManager.getDataMoveHistory(10);
                const hasHistoryData = Array.isArray(history);
                
                return {
                    requirement: '7.4',
                    name: 'ç§»å‹•å±¥æ­´è¡¨ç¤º',
                    passed: hasHistoryDisplayMethod && hasHistoryGetMethod && hasHistoryData,
                    details: `å±¥æ­´è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰: ${hasHistoryDisplayMethod ? 'âœ“' : 'âœ—'} | å±¥æ­´å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰: ${hasHistoryGetMethod ? 'âœ“' : 'âœ—'} | å±¥æ­´ãƒ‡ãƒ¼ã‚¿: ${history.length}ä»¶`
                };
                
            } catch (error) {
                return {
                    requirement: '7.4',
                    name: 'ç§»å‹•å±¥æ­´è¡¨ç¤º',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // è¦ä»¶7.5ãƒ†ã‚¹ãƒˆ: é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        async function testRequirement75() {
            try {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª
                const hasDuplicateCheckMethod = typeof dataManager.checkDuplicateData === 'function';
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
                const stores = storeManager.getStores();
                const testRecord = {
                    year: 2024,
                    month: 12,
                    amount: 100000,
                    category: 'ãƒ†ã‚¹ãƒˆ',
                    note: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨'
                };
                
                const duplicates = dataManager.checkDuplicateData('sales', testRecord, stores[0].id);
                const duplicateCheckWorks = Array.isArray(duplicates);
                
                return {
                    requirement: '7.5',
                    name: 'é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç¢ºèª',
                    passed: hasDuplicateCheckMethod && duplicateCheckWorks,
                    details: `é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰: ${hasDuplicateCheckMethod ? 'âœ“' : 'âœ—'} | ãƒã‚§ãƒƒã‚¯çµæœ: ${duplicateCheckWorks ? 'æ­£å¸¸' : 'ã‚¨ãƒ©ãƒ¼'} | é¡ä¼¼ãƒ‡ãƒ¼ã‚¿: ${duplicates.length}ä»¶`
                };
                
            } catch (error) {
                return {
                    requirement: '7.5',
                    name: 'é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç¢ºèª',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function displayTestResults(results) {
            let resultHTML = '<h3>çµ±åˆãƒ†ã‚¹ãƒˆçµæœ</h3>';
            resultHTML += '<table class="data-table"><thead><tr><th>è¦ä»¶</th><th>ãƒ†ã‚¹ãƒˆé …ç›®</th><th>çµæœ</th><th>è©³ç´°</th></tr></thead><tbody>';
            
            let passedCount = 0;
            results.forEach(result => {
                const status = result.passed ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';
                const statusClass = result.passed ? 'status-success' : 'status-error';
                
                if (result.passed) passedCount++;
                
                resultHTML += `
                    <tr>
                        <td><strong>${result.requirement}</strong></td>
                        <td>${result.name}</td>
                        <td class="${statusClass}">${status}</td>
                        <td>${result.details}</td>
                    </tr>
                `;
            });
            
            resultHTML += '</tbody></table>';
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const allPassed = passedCount === results.length;
            const summaryClass = allPassed ? 'status-success' : 'status-error';
            const summaryIcon = allPassed ? 'âœ…' : 'âŒ';
            
            resultHTML += `
                <div class="test-summary ${summaryClass}">
                    <h4>${summaryIcon} ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼: ${passedCount}/${results.length} è¦ä»¶ãŒå®Ÿè£…æ¸ˆã¿</h4>
                    ${allPassed ? 
                        '<p><strong>ğŸ‰ ã‚¿ã‚¹ã‚¯9ã€Œåº—èˆ—é–“ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ã®å®Ÿè£…ã€ã¯å®Œäº†ã—ã¦ã„ã¾ã™ï¼</strong></p>' : 
                        '<p><strong>âš ï¸ ä¸€éƒ¨ã®è¦ä»¶ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</strong></p>'
                    }
                </div>
            `;
            
            document.getElementById('test-results').innerHTML = resultHTML;
            
            const overallStatus = allPassed ? 
                'ã™ã¹ã¦ã®è¦ä»¶ãŒå®Ÿè£…æ¸ˆã¿ã§ã™ï¼ã‚¿ã‚¹ã‚¯9ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚' : 
                `${results.length - passedCount}ä»¶ã®è¦ä»¶ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`;
            const statusType = allPassed ? 'success' : 'error';
            showStatus(overallStatus, statusType);
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        async function clearTestData() {
            try {
                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                dataManager.resetAllData();
                
                // å…¨åº—èˆ—ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—ä»¥å¤–ï¼‰
                const stores = storeManager.getStores();
                for (const store of stores.slice(1)) { // æœ€åˆã®åº—èˆ—ã¯æ®‹ã™
                    try {
                        storeManager.deleteStore(store.id);
                    } catch (error) {
                        console.warn('åº—èˆ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                // ç§»å‹•å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
                localStorage.removeItem('kaikei-data-move-history');

                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('test-status');
            statusDiv.className = `${type}-message`;
            statusDiv.textContent = message;
            
            // 5ç§’å¾Œã«æ¶ˆå»
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }
    </script>
</body>
</html>