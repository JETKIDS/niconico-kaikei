<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½æ¤œè¨¼ - ã‚‚ã†ã‹ã‚Šã¾ã£ã‹</title>
    <link rel="stylesheet" href="kaikei/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½æ¤œè¨¼</h1>
        </header>

        <main>
            <div id="content-area">
                <div class="section-header">
                    <h2>ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h2>
                    <div class="section-controls">
                        <button class="btn btn-primary" onclick="runVerificationTests()">æ¤œè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                        <button class="btn btn-secondary" onclick="showTestResults()">çµæœè¡¨ç¤º</button>
                    </div>
                </div>

                <div id="test-results">
                    <h3>æ¤œè¨¼é …ç›®</h3>
                    <ul>
                        <li>âœ… ãƒ‡ãƒ¼ã‚¿ç§»å‹•é¸æŠUIï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰</li>
                        <li>âœ… ç§»å‹•å…ˆåº—èˆ—é¸æŠæ©Ÿèƒ½</li>
                        <li>âœ… ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½</li>
                        <li>âœ… ç§»å‹•å±¥æ­´ã®è¨˜éŒ²ã¨è¡¨ç¤ºæ©Ÿèƒ½</li>
                        <li>âœ… é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½</li>
                        <li>âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</li>
                    </ul>

                    <div id="verification-status"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="kaikei/js/store-manager.js"></script>
    <script src="kaikei/js/data-manager.js"></script>
    <script src="kaikei/js/ui-manager.js"></script>
    <script>
        let storeManager;
        let dataManager;
        let uiManager;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                storeManager = new StoreManager();
                dataManager = new DataManager();
                uiManager = new UIManager(dataManager);
                
                await storeManager.loadStoreData();
                await dataManager.loadData();
                
                window.storeManager = storeManager;
                window.dataManager = dataManager;
                window.uiManager = uiManager;
                
                showStatus('åˆæœŸåŒ–å®Œäº†', 'success');
            } catch (error) {
                showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // æ¤œè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runVerificationTests() {
            try {
                showStatus('æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'info');
                
                const results = [];
                
                // 1. StoreManagerã®åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testStoreManager());
                
                // 2. DataManagerã®ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testDataMovement());
                
                // 3. UIManagerã®é¸æŠæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testUISelection());
                
                // 4. ç§»å‹•å±¥æ­´æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testMoveHistory());
                
                // 5. é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testDuplicateCheck());
                
                displayTestResults(results);
                
            } catch (error) {
                showStatus('æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // StoreManageråŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testStoreManager() {
            try {
                // åº—èˆ—ä½œæˆãƒ†ã‚¹ãƒˆ
                const store1 = storeManager.addStore({
                    name: 'ãƒ†ã‚¹ãƒˆåº—èˆ—1',
                    address: 'ãƒ†ã‚¹ãƒˆä½æ‰€1',
                    openDate: '2024-01-01',
                    note: 'ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—1'
                });
                
                const store2 = storeManager.addStore({
                    name: 'ãƒ†ã‚¹ãƒˆåº—èˆ—2',
                    address: 'ãƒ†ã‚¹ãƒˆä½æ‰€2',
                    openDate: '2024-02-01',
                    note: 'ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—2'
                });
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åº—èˆ—è¨­å®šãƒ†ã‚¹ãƒˆ
                storeManager.setActiveStore(store1.id);
                const activeStore = storeManager.getActiveStore();
                
                return {
                    name: 'StoreManageråŸºæœ¬æ©Ÿèƒ½',
                    passed: activeStore && activeStore.id === store1.id,
                    details: `åº—èˆ—ä½œæˆ: ${store1.name}, ${store2.name} | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åº—èˆ—: ${activeStore?.name}`
                };
                
            } catch (error) {
                return {
                    name: 'StoreManageråŸºæœ¬æ©Ÿèƒ½',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testDataMovement() {
            try {
                const stores = storeManager.getStores();
                if (stores.length < 2) {
                    throw new Error('ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                storeManager.setActiveStore(stores[0].id);
                const record = dataManager.addRecord('sales', {
                    year: 2024,
                    month: 12,
                    amount: 100000,
                    note: 'ãƒ†ã‚¹ãƒˆå£²ä¸Šãƒ‡ãƒ¼ã‚¿'
                });
                
                // ãƒ‡ãƒ¼ã‚¿ç§»å‹•å®Ÿè¡Œ
                const movedRecord = dataManager.moveRecordToStore('sales', record.id, stores[1].id);
                
                return {
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½',
                    passed: movedRecord.storeId === stores[1].id,
                    details: `ãƒ¬ã‚³ãƒ¼ãƒ‰ç§»å‹•: ${stores[0].name} â†’ ${stores[1].name}`
                };
                
            } catch (error) {
                return {
                    name: 'ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // UIé¸æŠæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testUISelection() {
            try {
                // UIManagerã®ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª
                const methods = [
                    'selectAllRecords',
                    'clearSelection',
                    'updateSelectionCount',
                    'showDataMoveDialog',
                    'showSingleDataMoveDialog'
                ];
                
                const missingMethods = methods.filter(method => typeof uiManager[method] !== 'function');
                
                return {
                    name: 'UIé¸æŠæ©Ÿèƒ½',
                    passed: missingMethods.length === 0,
                    details: missingMethods.length === 0 ? 'å…¨ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…æ¸ˆã¿' : `æœªå®Ÿè£…ãƒ¡ã‚½ãƒƒãƒ‰: ${missingMethods.join(', ')}`
                };
                
            } catch (error) {
                return {
                    name: 'UIé¸æŠæ©Ÿèƒ½',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // ç§»å‹•å±¥æ­´æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testMoveHistory() {
            try {
                // ç§»å‹•å±¥æ­´å–å¾—ãƒ†ã‚¹ãƒˆ
                const history = dataManager.getDataMoveHistory(10);
                
                // UIManagerã®å±¥æ­´è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                const hasHistoryMethod = typeof uiManager.showDataMoveHistory === 'function';
                
                return {
                    name: 'ç§»å‹•å±¥æ­´æ©Ÿèƒ½',
                    passed: hasHistoryMethod && Array.isArray(history),
                    details: `å±¥æ­´ä»¶æ•°: ${history.length}ä»¶ | è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰: ${hasHistoryMethod ? 'å®Ÿè£…æ¸ˆã¿' : 'æœªå®Ÿè£…'}`
                };
                
            } catch (error) {
                return {
                    name: 'ç§»å‹•å±¥æ­´æ©Ÿèƒ½',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testDuplicateCheck() {
            try {
                const stores = storeManager.getStores();
                if (stores.length < 2) {
                    throw new Error('ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
                const testRecord = {
                    year: 2024,
                    month: 12,
                    amount: 50000,
                    category: 'ãƒ†ã‚¹ãƒˆ',
                    note: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨'
                };
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
                const duplicates = dataManager.checkDuplicateData('sales', testRecord, stores[0].id);
                
                return {
                    name: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½',
                    passed: Array.isArray(duplicates),
                    details: `é‡è¤‡ãƒã‚§ãƒƒã‚¯çµæœ: ${duplicates.length}ä»¶ã®é¡ä¼¼ãƒ‡ãƒ¼ã‚¿`
                };
                
            } catch (error) {
                return {
                    name: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½',
                    passed: false,
                    details: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }

        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function displayTestResults(results) {
            let resultHTML = '<h3>æ¤œè¨¼ãƒ†ã‚¹ãƒˆçµæœ</h3>';
            resultHTML += '<table class="data-table"><thead><tr><th>ãƒ†ã‚¹ãƒˆé …ç›®</th><th>çµæœ</th><th>è©³ç´°</th></tr></thead><tbody>';
            
            let passedCount = 0;
            results.forEach(result => {
                const status = result.passed ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';
                const statusClass = result.passed ? 'status-success' : 'status-error';
                
                if (result.passed) passedCount++;
                
                resultHTML += `
                    <tr>
                        <td>${result.name}</td>
                        <td class="${statusClass}">${status}</td>
                        <td>${result.details}</td>
                    </tr>
                `;
            });
            
            resultHTML += '</tbody></table>';
            resultHTML += `<div class="test-summary"><h4>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼: ${passedCount}/${results.length} é …ç›®ãŒæˆåŠŸ</h4></div>`;
            
            document.getElementById('test-results').innerHTML = resultHTML;
            
            const overallStatus = passedCount === results.length ? 'ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ' : `${results.length - passedCount}ä»¶ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ`;
            const statusType = passedCount === results.length ? 'success' : 'warning';
            showStatus(overallStatus, statusType);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('verification-status');
            statusDiv.className = `${type}-message`;
            statusDiv.textContent = message;
            
            // 5ç§’å¾Œã«æ¶ˆå»
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        // çµæœè¡¨ç¤º
        function showTestResults() {
            const stores = storeManager.getStores();
            const history = dataManager.getDataMoveHistory(10);
            
            let resultHTML = '<h3>ç¾åœ¨ã®çŠ¶æ…‹</h3>';
            resultHTML += `<p><strong>åº—èˆ—æ•°:</strong> ${stores.length}åº—èˆ—</p>`;
            resultHTML += `<p><strong>ç§»å‹•å±¥æ­´:</strong> ${history.length}ä»¶</p>`;
            resultHTML += `<p><strong>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åº—èˆ—:</strong> ${storeManager.getActiveStore()?.name || 'ãªã—'}</p>`;
            
            document.getElementById('test-results').innerHTML = resultHTML;
        }
    </script>
</body>
</html>