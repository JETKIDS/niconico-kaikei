<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - ã‚‚ã†ã‹ã‚Šã¾ã£ã‹</title>
    <link rel="stylesheet" href="kaikei/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        </header>

        <main>
            <div id="content-area">
                <div class="section-header">
                    <h2>ãƒ‡ãƒ¼ã‚¿ç§»å‹•æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
                    <div class="section-controls">
                        <button class="btn btn-primary" onclick="initializeTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ</button>
                        <button class="btn btn-secondary" onclick="showTestResults()">ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º</button>
                        <button class="btn btn-danger" onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>

                <div id="test-results">
                    <h3>ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
                    <ol>
                        <li>ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è¤‡æ•°åº—èˆ—ã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ</li>
                        <li>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆindex.htmlï¼‰ã‚’é–‹ã</li>
                        <li>åº—èˆ—ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€å„åº—èˆ—ã«ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                        <li>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãªã©ã®ç”»é¢ã§ã€è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ã€Œé¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç§»å‹•ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ç§»å‹•å…ˆåº—èˆ—ã‚’é¸æŠã—ã¦ç§»å‹•ã‚’å®Ÿè¡Œ</li>
                        <li>åº—èˆ—ç®¡ç†ç”»é¢ã§ã€Œãƒ‡ãƒ¼ã‚¿ç§»å‹•å±¥æ­´ã€ã‚’ç¢ºèª</li>
                        <li>ç§»å‹•ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãç§»å‹•å…ˆåº—èˆ—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                    </ol>

                    <div id="test-status"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="kaikei/js/store-manager.js"></script>
    <script src="kaikei/js/data-manager.js"></script>
    <script>
        let storeManager;
        let dataManager;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                storeManager = new StoreManager();
                dataManager = new DataManager();
                
                await storeManager.loadStores();
                await dataManager.loadData();
                
                window.storeManager = storeManager;
                window.dataManager = dataManager;
                
                showStatus('åˆæœŸåŒ–å®Œäº†', 'success');
            } catch (error) {
                showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
        async function initializeTestData() {
            try {
                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­...', 'info');

                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                await clearTestData();

                // ãƒ†ã‚¹ãƒˆåº—èˆ—ã‚’ä½œæˆ
                const store1 = await storeManager.addStore({
                    name: 'æœ¬åº—',
                    address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1',
                    openDate: '2024-01-01',
                    note: 'ãƒ¡ã‚¤ãƒ³åº—èˆ—'
                });

                const store2 = await storeManager.addStore({
                    name: 'æ”¯åº—A',
                    address: 'æ±äº¬éƒ½æ–°å®¿åŒº2-2-2',
                    openDate: '2024-02-01',
                    note: 'æ”¯åº—A'
                });

                const store3 = await storeManager.addStore({
                    name: 'æ”¯åº—B',
                    address: 'æ±äº¬éƒ½æ± è¢‹åŒº3-3-3',
                    openDate: '2024-03-01',
                    note: 'æ”¯åº—B'
                });

                // æœ¬åº—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«è¨­å®š
                storeManager.setActiveStore(store1.id);

                // æœ¬åº—ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                await createStoreTestData(store1.id, 'æœ¬åº—');
                
                // æ”¯åº—Aã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                storeManager.setActiveStore(store2.id);
                await createStoreTestData(store2.id, 'æ”¯åº—A');

                // æ”¯åº—Bã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                storeManager.setActiveStore(store3.id);
                await createStoreTestData(store3.id, 'æ”¯åº—B');

                // æœ¬åº—ã«æˆ»ã™
                storeManager.setActiveStore(store1.id);

                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                showTestResults();

            } catch (error) {
                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // åº—èˆ—åˆ¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
        async function createStoreTestData(storeId, storeName) {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
            dataManager.addRecord('sales', {
                year: currentYear,
                month: currentMonth,
                amount: 500000 + Math.floor(Math.random() * 200000),
                note: `${storeName}ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿1`
            }, storeId);

            dataManager.addRecord('sales', {
                year: currentYear,
                month: currentMonth - 1 > 0 ? currentMonth - 1 : 12,
                amount: 450000 + Math.floor(Math.random() * 150000),
                note: `${storeName}ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿2`
            }, storeId);

            // ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿
            dataManager.addRecord('purchases', {
                year: currentYear,
                month: currentMonth,
                amount: 200000 + Math.floor(Math.random() * 100000),
                manufacturer: `${storeName}ä»•å…¥å…ˆA`,
                note: `${storeName}ã®ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿1`
            }, storeId);

            // å›ºå®šè²»ãƒ‡ãƒ¼ã‚¿
            dataManager.addRecord('fixedCosts', {
                year: currentYear,
                month: currentMonth,
                category: 'å®¶è³ƒ',
                amount: 100000 + Math.floor(Math.random() * 50000),
                note: `${storeName}ã®å®¶è³ƒ`
            }, storeId);

            dataManager.addRecord('fixedCosts', {
                year: currentYear,
                month: currentMonth,
                category: 'å…‰ç†±è²»',
                amount: 30000 + Math.floor(Math.random() * 20000),
                note: `${storeName}ã®å…‰ç†±è²»`
            }, storeId);
        }

        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function showTestResults() {
            const stores = storeManager.getStores();
            const allData = dataManager.getAllData();
            
            let resultHTML = '<h3>ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</h3>';
            
            resultHTML += '<h4>åº—èˆ—ä¸€è¦§</h4><ul>';
            stores.forEach(store => {
                const recordCount = dataManager.getStoreRecordCount(store.id);
                resultHTML += `<li><strong>${store.name}</strong> (ID: ${store.id.substring(0, 8)}...) - ${recordCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</li>`;
            });
            resultHTML += '</ul>';

            resultHTML += '<h4>ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒ</h4>';
            resultHTML += '<table class="data-table"><thead><tr><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>ç·ä»¶æ•°</th><th>åº—èˆ—åˆ¥å†…è¨³</th></tr></thead><tbody>';
            
            for (const category in allData) {
                if (category === 'dataMoveHistory') continue;
                
                const totalCount = allData[category].length;
                let storeBreakdown = '';
                
                stores.forEach(store => {
                    const storeCount = allData[category].filter(record => record.storeId === store.id).length;
                    if (storeCount > 0) {
                        storeBreakdown += `${store.name}: ${storeCount}ä»¶ `;
                    }
                });
                
                resultHTML += `<tr><td>${getCategoryDisplayName(category)}</td><td>${totalCount}</td><td>${storeBreakdown}</td></tr>`;
            }
            
            resultHTML += '</tbody></table>';

            // ç§»å‹•å±¥æ­´ãŒã‚ã‚Œã°è¡¨ç¤º
            const moveHistory = dataManager.getDataMoveHistory(10);
            if (moveHistory.length > 0) {
                resultHTML += '<h4>ãƒ‡ãƒ¼ã‚¿ç§»å‹•å±¥æ­´</h4>';
                resultHTML += '<table class="data-table"><thead><tr><th>æ—¥æ™‚</th><th>ãƒ¬ã‚³ãƒ¼ãƒ‰ID</th><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>ç§»å‹•å…ƒâ†’ç§»å‹•å…ˆ</th></tr></thead><tbody>';
                
                moveHistory.forEach(history => {
                    const timestamp = new Date(history.movedAt).toLocaleString('ja-JP');
                    const fromStore = stores.find(s => s.id === history.fromStoreId)?.name || 'ä¸æ˜';
                    const toStore = stores.find(s => s.id === history.toStoreId)?.name || 'ä¸æ˜';
                    
                    resultHTML += `<tr><td>${timestamp}</td><td>${history.recordId.substring(0, 8)}...</td><td>${getCategoryDisplayName(history.category)}</td><td>${fromStore} â†’ ${toStore}</td></tr>`;
                });
                
                resultHTML += '</tbody></table>';
            }

            document.getElementById('test-results').innerHTML = resultHTML;
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        async function clearTestData() {
            try {
                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ä¸­...', 'info');
                
                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                dataManager.resetAllData();
                
                // å…¨åº—èˆ—ã‚’å‰Šé™¤
                const stores = storeManager.getStores();
                for (const store of stores) {
                    await storeManager.deleteStore(store.id);
                }

                // ç§»å‹•å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
                localStorage.removeItem('kaikei-data-move-history');

                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                document.getElementById('test-results').innerHTML = '<p>ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚</p>';

            } catch (error) {
                showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('test-status');
            statusDiv.className = `${type}-message`;
            statusDiv.textContent = message;
            
            // 3ç§’å¾Œã«æ¶ˆå»
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼è¡¨ç¤ºåå–å¾—
        function getCategoryDisplayName(category) {
            const names = {
                sales: 'å£²ä¸Š',
                purchases: 'ä»•å…¥ã‚Œ',
                fixedCosts: 'å›ºå®šè²»',
                variableCosts: 'å¤‰å‹•è²»',
                laborCosts: 'äººä»¶è²»',
                consumptionTax: 'æ¶ˆè²»ç¨',
                monthlyPayments: 'æœˆæ¬¡æ”¯æ‰•ã„',
                manufacturerDeposits: 'ãƒ¡ãƒ¼ã‚«ãƒ¼é ã‚Šé‡‘'
            };
            return names[category] || category;
        }
    </script>
</body>
</html>