<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ä¿®æ­£ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="kaikei/css/style.css">
    <style>
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #d6c8b8;
            border-radius: 8px;
            background-color: #fdfaf5;
        }
        .test-title {
            color: #8b0000;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #e0ffe0;
            border: 1px solid #408040;
            color: #2d5a2d;
        }
        .error {
            background-color: #ffe0e0;
            border: 1px solid #d05050;
            color: #8b0000;
        }
        .info {
            background-color: #e0e0ff;
            border: 1px solid #8080c0;
            color: #404080;
        }
        .data-structure {
            background-color: #f5f0e8;
            border: 1px solid #d6c8b8;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ãƒ¬ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>
        </header>

        <main>
            <div id="content-area">
                <div class="test-section">
                    <h2 class="test-title">1. StoreManagerãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª</h2>
                    <p>StoreManagerã‚¯ãƒ©ã‚¹ã®åˆ©ç”¨å¯èƒ½ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                    <div id="store-manager-results"></div>
                    <button class="btn btn-primary" onclick="checkStoreManagerMethods()">ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª</button>
                </div>

                <div class="test-section">
                    <h2 class="test-title">2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª</h2>
                    <p>ChartManagerã‹ã‚‰è¿”ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                    <div id="data-structure-results"></div>
                    <button class="btn btn-primary" onclick="checkDataStructure()">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª</button>
                </div>

                <div class="test-section">
                    <h2 class="test-title">3. çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ãƒ†ã‚¹ãƒˆ</h2>
                    <p>ä¿®æ­£ã•ã‚ŒãŸçµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                    <div id="consolidated-results"></div>
                    <button class="btn btn-primary" onclick="testConsolidatedReport()">çµ±åˆãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ</button>
                </div>

                <div class="test-section">
                    <h2 class="test-title">4. æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ãƒ†ã‚¹ãƒˆ</h2>
                    <p>ä¿®æ­£ã•ã‚ŒãŸæ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                    <div id="comparison-results"></div>
                    <button class="btn btn-primary" onclick="testComparisonReport()">æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ</button>
                </div>

                <div class="test-section">
                    <h2 class="test-title">5. ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç¢ºèª</h2>
                    <p>ä¿®æ­£å‰ã«ç™ºç”Ÿã—ã¦ã„ãŸã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                    <div id="error-check-results"></div>
                    <button class="btn btn-primary" onclick="checkErrorFixes()">ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç¢ºèª</button>
                </div>
            </div>
        </main>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="kaikei/js/data-manager.js"></script>
    <script src="kaikei/js/store-manager.js"></script>
    <script src="kaikei/js/chart-manager.js"></script>

    <script>
        let testDataManager, testStoreManager, testChartManager;

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function addDataStructure(containerId, data) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'data-structure';
            div.textContent = JSON.stringify(data, null, 2);
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function initializeTestEnvironment() {
            try {
                testDataManager = new DataManager();
                testStoreManager = new StoreManager();
                testChartManager = new ChartManager(testDataManager);

                window.dataManager = testDataManager;
                window.storeManager = testStoreManager;
                window.chartManager = testChartManager;

                await testStoreManager.loadStoreData();
                await testDataManager.loadData();

                // ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—ã‚’è¿½åŠ 
                if (testStoreManager.getStoreCount() === 0) {
                    const store1 = testStoreManager.addStore({
                        name: 'ãƒ†ã‚¹ãƒˆæœ¬åº—',
                        address: 'æ±äº¬éƒ½æ¸‹è°·åŒº',
                        openDate: '2020-01-01',
                        note: 'ãƒ†ã‚¹ãƒˆç”¨åº—èˆ—'
                    });
                    
                    const store2 = testStoreManager.addStore({
                        name: 'ãƒ†ã‚¹ãƒˆæ”¯åº—',
                        address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚',
                        openDate: '2021-06-01',
                        note: 'ãƒ†ã‚¹ãƒˆç”¨æ”¯åº—'
                    });

                    testStoreManager.setActiveStore(store1.id);

                    // ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    testDataManager.addRecord('sales', {
                        year: 2024,
                        month: 12,
                        amount: 1000000,
                        note: 'ãƒ†ã‚¹ãƒˆå£²ä¸Š',
                        storeId: store1.id
                    });

                    testDataManager.addRecord('purchases', {
                        year: 2024,
                        month: 12,
                        amount: 600000,
                        manufacturer: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼',
                        note: 'ãƒ†ã‚¹ãƒˆä»•å…¥',
                        storeId: store1.id
                    });

                    testDataManager.addRecord('sales', {
                        year: 2024,
                        month: 12,
                        amount: 800000,
                        note: 'ãƒ†ã‚¹ãƒˆå£²ä¸Š',
                        storeId: store2.id
                    });

                    testDataManager.addRecord('purchases', {
                        year: 2024,
                        month: 12,
                        amount: 400000,
                        manufacturer: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼',
                        note: 'ãƒ†ã‚¹ãƒˆä»•å…¥',
                        storeId: store2.id
                    });
                }

                return true;
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        function checkStoreManagerMethods() {
            clearResults('store-manager-results');
            
            try {
                if (typeof StoreManager === 'function') {
                    addResult('store-manager-results', 'âœ“ StoreManagerã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™', 'success');
                } else {
                    addResult('store-manager-results', 'âŒ StoreManagerã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }

                const testStore = new StoreManager();
                
                // åˆ©ç”¨å¯èƒ½ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                const methods = [
                    'getStores',
                    'getAllStores',
                    'getStoreById',
                    'getActiveStore',
                    'addStore',
                    'updateStore',
                    'deleteStore'
                ];

                methods.forEach(method => {
                    if (typeof testStore[method] === 'function') {
                        addResult('store-manager-results', `âœ“ ${method}ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™`, 'success');
                    } else {
                        addResult('store-manager-results', `âŒ ${method}ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“`, 'error');
                    }
                });

            } catch (error) {
                addResult('store-manager-results', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function checkDataStructure() {
            clearResults('data-structure-results');
            
            try {
                const initialized = await initializeTestEnvironment();
                if (!initialized) {
                    addResult('data-structure-results', 'âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }

                // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
                const consolidatedData = testChartManager.calculateConsolidatedBalance(2024, 12);
                addResult('data-structure-results', 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ :', 'info');
                addDataStructure('data-structure-results', consolidatedData);

                // æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
                const comparisonData = testChartManager.calculateStoreComparison(2024, 12);
                addResult('data-structure-results', 'æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ :', 'info');
                addDataStructure('data-structure-results', comparisonData);

            } catch (error) {
                addResult('data-structure-results', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function testConsolidatedReport() {
            clearResults('consolidated-results');
            
            try {
                const initialized = await initializeTestEnvironment();
                if (!initialized) {
                    addResult('consolidated-results', 'âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }

                // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—
                const consolidatedData = testChartManager.calculateConsolidatedBalance(2024, 12);
                addResult('consolidated-results', 'âœ“ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ãŒæˆåŠŸã—ã¾ã—ãŸ', 'success');
                
                // ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                if (typeof consolidatedData.totalIncome === 'number') {
                    addResult('consolidated-results', `âœ“ totalIncome: ${consolidatedData.totalIncome.toLocaleString()}å††`, 'success');
                } else {
                    addResult('consolidated-results', 'âŒ totalIncomeãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }

                if (typeof consolidatedData.totalExpense === 'number') {
                    addResult('consolidated-results', `âœ“ totalExpense: ${consolidatedData.totalExpense.toLocaleString()}å††`, 'success');
                } else {
                    addResult('consolidated-results', 'âŒ totalExpenseãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }

                if (typeof consolidatedData.balance === 'number') {
                    addResult('consolidated-results', `âœ“ balance: ${consolidatedData.balance.toLocaleString()}å††`, 'success');
                } else {
                    addResult('consolidated-results', 'âŒ balanceãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }

                if (Array.isArray(consolidatedData.stores)) {
                    addResult('consolidated-results', `âœ“ storesé…åˆ—: ${consolidatedData.stores.length}åº—èˆ—`, 'success');
                } else {
                    addResult('consolidated-results', 'âŒ storesãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }

            } catch (error) {
                addResult('consolidated-results', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('çµ±åˆãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function testComparisonReport() {
            clearResults('comparison-results');
            
            try {
                const initialized = await initializeTestEnvironment();
                if (!initialized) {
                    addResult('comparison-results', 'âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }

                // æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—
                const comparisonData = testChartManager.calculateStoreComparison(2024, 12);
                addResult('comparison-results', 'âœ“ æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ãŒæˆåŠŸã—ã¾ã—ãŸ', 'success');
                
                if (Array.isArray(comparisonData)) {
                    addResult('comparison-results', `âœ“ æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿é…åˆ—: ${comparisonData.length}åº—èˆ—`, 'success');
                    
                    comparisonData.forEach((store, index) => {
                        if (store.store && store.store.name) {
                            addResult('comparison-results', `âœ“ åº—èˆ—${index + 1}: ${store.store.name}`, 'success');
                            
                            if (typeof store.income === 'number') {
                                addResult('comparison-results', `  - åå…¥: ${store.income.toLocaleString()}å††`, 'info');
                            }
                            if (typeof store.expense === 'number') {
                                addResult('comparison-results', `  - æ”¯å‡º: ${store.expense.toLocaleString()}å††`, 'info');
                            }
                            if (typeof store.balance === 'number') {
                                addResult('comparison-results', `  - åæ”¯: ${store.balance.toLocaleString()}å††`, 'info');
                            }
                        } else {
                            addResult('comparison-results', `âŒ åº—èˆ—${index + 1}: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒä¸æ­£`, 'error');
                        }
                    });
                } else {
                    addResult('comparison-results', 'âŒ æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }

            } catch (error) {
                addResult('comparison-results', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function checkErrorFixes() {
            clearResults('error-check-results');
            
            try {
                const initialized = await initializeTestEnvironment();
                if (!initialized) {
                    addResult('error-check-results', 'âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }

                // ä¿®æ­£å‰ã®ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾ã—ã¦ã¿ã‚‹
                let errorCount = 0;

                // 1. getAllStoresã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
                try {
                    const stores = window.storeManager.getStores();
                    if (Array.isArray(stores)) {
                        addResult('error-check-results', 'âœ“ getStores()ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™', 'success');
                    } else {
                        addResult('error-check-results', 'âŒ getStores()ãŒé…åˆ—ã‚’è¿”ã—ã¾ã›ã‚“', 'error');
                        errorCount++;
                    }
                } catch (error) {
                    addResult('error-check-results', `âŒ getStores()ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    errorCount++;
                }

                // 2. çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
                try {
                    const consolidatedData = window.chartManager.calculateConsolidatedBalance(2024, 12);
                    if (consolidatedData && typeof consolidatedData.totalIncome === 'number') {
                        addResult('error-check-results', 'âœ“ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸ', 'success');
                    } else {
                        addResult('error-check-results', 'âŒ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã®æˆ»ã‚Šå€¤ãŒä¸æ­£ã§ã™', 'error');
                        errorCount++;
                    }
                } catch (error) {
                    addResult('error-check-results', `âŒ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    errorCount++;
                }

                // 3. æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
                try {
                    const comparisonData = window.chartManager.calculateStoreComparison(2024, 12);
                    if (Array.isArray(comparisonData)) {
                        addResult('error-check-results', 'âœ“ æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸ', 'success');
                    } else {
                        addResult('error-check-results', 'âŒ æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã®æˆ»ã‚Šå€¤ãŒä¸æ­£ã§ã™', 'error');
                        errorCount++;
                    }
                } catch (error) {
                    addResult('error-check-results', `âŒ æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    errorCount++;
                }

                if (errorCount === 0) {
                    addResult('error-check-results', 'ğŸ‰ ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    addResult('error-check-results', `âš ï¸ ${errorCount}å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒæ®‹ã£ã¦ã„ã¾ã™`, 'error');
                }

            } catch (error) {
                addResult('error-check-results', `âŒ ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkStoreManagerMethods();
            }, 1000);
        });
    </script>
</body>
</html>